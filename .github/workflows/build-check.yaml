name: Build Check

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  check-schema:
    runs-on: ubuntu-latest
    steps:
    - name: check out code
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

    - name: install dependencies
      run: npm install

    - name: compile schema
      run: make compile-schema

    - name: validate example
      run: make validate-examples

    - name: make all
      run: make all

    - name: check for diff
      run: |
        # need to "git add" to detect any changes which are not checked in
        # select files from locations managed by meta schema
        git add schema/meta_schema_*
        git add schema-docs.md
        git add language-support-status.md
        if git diff --cached --quiet
        then 
          echo "No diff detected."
        else 
          echo "Diff detected - did you run 'make all'?"
          echo $(git diff --cached --name-only)
          echo $(git diff --cached)
          exit 1
        fi
